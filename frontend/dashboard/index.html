<!DOCTYPE html>
<html class="no-js" lang="en" >

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Ingage Dashboard</title>

    <link rel="stylesheet" href="css/dashboard.css">

    <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
    <script src="js/vendor/custom.modernizr.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.2/underscore-min.js" type="text/javascript"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/0.9.2/backbone-min.js"></script>
    <script src="js/backbone.basicauth.js"></script>
    <script src="js/md5.js"></script>
    <script src="http://timeago.yarp.com/jquery.timeago.js"></script>
</head>

<body>
    
    <div class="main-app"></div>

    <script type="text/template" id="login-template">
        <header class="top-nav">
            <div class="row">
                <div class="large-3 columns">
                    <h1><img src="images/logo.png" alt="Ingage Dashbaord"></h1>	
                </div>
                <div class="large-9 columns">
                    <ul class="inline-list nav-list right">
                        <li><a href="#" >Contact</a></li>
                    </ul>
                </div>
            </div>
        </header> <!-- End Header and Nav -->

        <div class="row login">
            <div class="large-4 columns">
                <p class="primary-message">You in-venue customer feedback collection and management tool</p>
            </div>
            <div class="large-3 large-offset-1 columns">
                <img src="images/phone.png" >
            </div>
            <div class="large-3 large-offet-1 columns login-form panel">
                <form id="login-form" name="login-form">
                    <fieldset>
                        <div class="form-element">
                        <label for="name">Username: </label>
                        <input type="text" required id="name" name="username" />
                        <label for="password">Password: </label>
                        <input type="password" required id="password" name="password" />
                        </div>
                    </fieldset>
                    <div class="form-element text-right">
                    <button type="submit" class="small primary">Log in</button>
                    </div>
                </form>    
                <p>Want to Sign up? Reach us at ingage@mutinylabs.in</p>
            </div>
        </div> <!-- End main page body -->
    </script>

    <script type="text/template" id="header-template">
        <header class="top-nav">
            <div class="row">
                <div class="large-3 columns">
                    <h1><img src="images/logo.png" alt="Ingage Dashbaord"></h1>	
                </div>
                <div class="large-9 columns">
                    <ul class="inline-list nav-list right">
                        <li class="secondary secondary-color">Welcome <%= username %></li>
                        <li><a href="/list_form.html" >System</a></li>
                        <li><a href="#" >Log Out</a></li>
                    </ul>
                </div>
            </div>
        </header>
    </script>

    <script type="text/template" id="feedback-timeline-template">
        <div class="row collapse">
            <dl class="sub-nav action-nav large-12 columns">
            <dd class="checkbox-dd"><form class="custom"><input type="checkbox" id="checkbox1" style="display: none;"></form></dd>
            <dd class="active"><a href="#">All</a></dd>
            <dd><a href="#">Mark as Read</a></dd>
            <dd><a href="#">Delete</a></dd>
            <dd><a href="#">Label</a></dd>
            </dl>
        </div>

        <div class="row">
            <div class="large-9 columns feedback-column">
                <ul class="feedback-list">
                    <% _.each(feedbacks, function(feedback){ %>
                        <li class="row">
                            <form class="custom large-1 columns"><input type="checkbox" id="checkbox1" style="display: none;"></form>
                            <span class="large-2 columns"><%= feedback.get("instance").name %></span>
                            <span class="large-7 columns feedback-content">
                                <span class="customer-name">
                                    <% if (feedback.get("customer").name) { %>
                                        <strong><%= feedback.get("customer").name %></strong>
                                    <% } else { %>
                                        No Name
                                    <% } %>
                                </span> - 
                                <span class="customer-message">
                                    <%= feedback.get("text") %>
                                </span>
                            </span>
                            <span class="large-2 columns text-right"><%= $.timeago(feedback.get("received_at")) %></span>
                            <input type="hidden" name="feedback_id" value="<%= feedback.get('id') %>">
                        </li>
                    <% }); %>
                </ul>
            </div>
        </div>
    </script>

    <script type="text/template" id="timeline-customer-details-template">
        <aside id="details" class="large-3 columns details-column">
            <div class="panel">
                <h3>
                    <% if (feedback.get('customer').name) { %>
                        <%= feedback.get('customer').name %>
                    <% } else { %>
                        No Name
                    <% } %>
                </h3>
                <div class="row collapse">
                    <div class="large-4 columns">
                        <% if (feedback.get('customer').email) { %>
                            <img src="http://www.gravatar.com/avatar/<%= MD5(feedback.get('customer').email) %>">
                        <% } else { %>
                            <img src="http://www.gravatar.com/avatar/">
                        <% } %>
                        </div>
                        <div class="large-8 columns">
                        <ul class="naked secondary contact-details">
                            <li> 
                                <% if (feedback.get('customer').email) { %>
                                    <%= feedback.get('customer').email %>
                                <% } else { %>
                                    No e-Mail
                                <% } %>
                            </li>
                            <li>
                                <% if (feedback.get('customer').mobile) { %>
                                    <%= feedback.get('customer').mobile %>
                                <% } else { %>
                                    No Mobile
                                <% } %>
                            </li>
                        </ul>
                    </div>
                </div>
                <hr>
                <div class="secondary-color secondary row collapse">
                    <div class="text-left large-5 columns">
                        <% var received_at = new Date(feedback.get("received_at")) %>
                        <%= received_at.getHours() %>:<%= received_at.getMinutes() %>
                    </div>
                    <div class="text-right large-7 columns">
                        <%= received_at.getDate() %>-<%= received_at.getMonth() %>-<%= received_at.getFullYear() %>
                    </div>
                </div>
                <hr>
                <p class="secondary">
                    <%= feedback.get("text") %>
                </p>
                <h3>Instance Details</h3>
                <div class="form-details secondary">
                    <div class="row collapse">
                        <div class="large-4 columns secondary-color">Name:</div><div class="large-8 columns">
                            <%= feedback.get("instance").name %>
                        </div>
                        <div class="large-4 columns secondary-color">Location:</div><div class="large-8 columns">
                            <%= feedback.get("instance").location %>
                        </div>
                        <div class="large-4 columns secondary-color">Details:</div><div class="large-8 columns">
                            <%= feedback.get("instance").description %>
                        </div>
                </div>
            </div>
        </aside>
    </script>

    <script type="text/template" id="footer-template">
        <footer class="row">
            <div class="large-12 columns secondary secondary-color">
                <hr />
                <div class="row">
                    <div class="large-5 columns">
                        <p>&copy; Copyright Mutiny Labs 2013</p>
                    </div>
                    <div class="large-7 columns">
                        <ul class="inline-list nav-list right">
                            <li><a href="#">Legal</a></li>
                        </ul> 
                    </div>
                </div>
            </div>
        </footer> <!-- End footer -->
    </script>
    
    <script type="text/javascript">

        $.fn.serializeObject = function() {
            var o = {};
            var a = this.serializeArray();
            $.each(a, function() {
                if (o[this.name] !== undefined) {
                    if (!o[this.name].push) {
                        o[this.name] = [o[this.name]];
                    }
                    o[this.name].push(this.value || '');
                } else {
                    o[this.name] = this.value || '';
                }
            });
            return o;
        };

        var Router = Backbone.Router.extend({
            routes: {
                "": "login",
                "timeline": "feedbackTimeline",
            }
        });
            
        var api_root = 'ingage.herokuapp.com'

        var UserCredentialsModel = Backbone.Model.extend();
        var userCredentialsModel = new UserCredentialsModel();

        var FeedbackTimelineCollection = Backbone.Collection.extend({
            url: "http://" + api_root + "/dashboard/timeline",
            parse: function(response, xhr){
                return response.feedbacks;
            }
        });

        var LoginView = Backbone.View.extend({
            el: '.main-app',
            events: {
                'submit #login-form': 'loginUser'
            },
            loginUser: function(ev){
                ev.preventDefault();
                var credentials = $(ev.currentTarget).serializeObject();
                $.ajax({
                    type: "GET",
                    url: "http://" + api_root + "/dashboard/auth/check_credentials",
                    headers: Backbone.BasicAuth.getHeader({ username: credentials.username, password: credentials.password }),
                    success: function(data){
                        userCredentialsModel.username = credentials.username;
                        userCredentialsModel.password = credentials.password;
                        router.navigate('timeline', {trigger: true});
                    },
                        error: function(data){
                        //TODO: proper error handling
                        alert("There was a problem with username/password combination");
                    } 
                });
            },
            render: function(){
                if (userCredentialsModel.username && userCredentialsModel.password){
                    router.navigate('timeline', {trigger: true});
                    return false
                }
                var template = _.template($("#login-template").html(), {});
                var footerTemplate = _.template($("#footer-template").html(), {});
                this.$el.html(template);
                this.$el.append(footerTemplate);
            }
        });
        var loginView = new LoginView();

        var FeedbackTimelineView = Backbone.View.extend({
            el: '.main-app',
            events: {
                'click li[class=row]': 'showCustomerDetails',
            },
            showCustomerDetails: function(ev){
                var feedbackID = $(ev.currentTarget).find("input[type=hidden]")[0].value;
                var feedback = feedbackTimelineCollection.get(feedbackID);
                var template = _.template($("#timeline-customer-details-template").html(), {feedback: feedback});
                var toRemoveClass = $("li.row.selected").removeClass("selected"); // remove already existng 'selected' class
                $(ev.currentTarget).addClass("selected"); // add 'selected' class to clicked li element
                var toAppendTo = $(ev.currentTarget.parentElement.parentElement.parentElement); // element to append details
                var toRemove = $("aside[id=details]") // already existing details to remove
                if (toRemove){
                    toRemove.remove();
                }
                toAppendTo.append(template);
            },
            render: function(){
                var that = this;
                // fetching feedback timeline
                feedbackTimelineCollection = new FeedbackTimelineCollection();
                feedbackTimelineCollection.credentials = {
                    username: "aditayanayak",
                    password: "adityanayak"
                };
                feedbackTimelineCollection.fetch({
                    success: function(feedbacks){
                        // rendering
                        var template = _.template($("#feedback-timeline-template").html(), {feedbacks: feedbacks.models});
                        var headerTemplate = _.template($("#header-template").html(), {username: userCredentialsModel.username});
                        var footerTemplate = _.template($("#footer-template").html(), {});
                        that.$el.html(template);
                        that.$el.prepend(headerTemplate);
                        that.$el.append(footerTemplate);
                        $(document).foundation(); 
                    }
                });
            }
        });
        var feedbackTimelineView = new FeedbackTimelineView();

        var router = new Router();
        router.on('route:login', function(){
            loginView.render();
        });
        router.on('route:feedbackTimeline', function(){
            feedbackTimelineView.render();
        });
        Backbone.history.start();
    </script>

    <script type="text/javascript">
        document.write('<script src=' +
        ('__proto__' in {} ? 'js/vendor/zepto' : 'js/vendor/jquery') +
        '.js><\/script>')
    </script>
    <script src="js/foundation/foundation.js"></script>
	<script src="js/foundation/foundation.forms.js"></script>
    <script>
        $( document ).ready(function() {
            $(document).foundation();
        });
    </script>
    
</body>
</html>
